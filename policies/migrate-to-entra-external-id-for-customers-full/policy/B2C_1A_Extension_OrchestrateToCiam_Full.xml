<TrustFrameworkPolicy xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:xsd="http://www.w3.org/2001/XMLSchema"
	xmlns="http://schemas.microsoft.com/online/cpim/schemas/2013/06" PolicySchemaVersion="0.3.0.0"
	TenantId="tenant.onmicrosoft.com" PolicyId="B2C_1A_OrchestrateToCiam_Full"
	PublicPolicyUri="http://tenant.onmicrosoft.com/B2C_1A_OrchestrateToCiam_Full"
	DeploymentMode="Development"
	UserJourneyRecorderEndpoint="urn:journeyrecorder:applicationinsights">

	<!--
   Please modify policyId to save the policy. 
   Please find the schema reference at
	https://docs.microsoft.com/en-us/azure/active-directory-b2c/trustframeworkpolicy.
 -->
	<BasePolicy>
		<TenantId>tenant.onmicrosoft.com</TenantId>
		<PolicyId>B2C_1A_MFA_TRUSTFRAMEWORKEXTENSIONS</PolicyId>
	</BasePolicy>

	<BuildingBlocks>
		<ClaimsSchema>
			<ClaimType Id="signInNames.phoneNumber">
				<DataType>phoneNumber</DataType>
			</ClaimType>

			<ClaimType Id="phoneNumberString">
				<DataType>string</DataType>
			</ClaimType>

			<ClaimType Id="groups">
				<DisplayName>groups</DisplayName>
				<DataType>stringCollection</DataType>
				<UserHelpText />
			</ClaimType>

			<ClaimType Id="roles">
				<DisplayName>roles</DisplayName>
				<DataType>stringCollection</DataType>
				<UserHelpText />
			</ClaimType>

			<ClaimType Id="newlyEnrolled">
				<DisplayName>newlyEnrolled</DisplayName>
				<DataType>string</DataType>
				<UserHelpText />
			</ClaimType>

			<ClaimType Id="graph_bearerToken">
				<DisplayName>Bearer token</DisplayName>
				<DataType>string</DataType>
			</ClaimType>

			<ClaimType Id="method">
				<DisplayName>api method</DisplayName>
				<DataType>string</DataType>
			</ClaimType>

			<ClaimType Id="errorMessage">
				<DisplayName>Error Message</DisplayName>
				<DataType>string</DataType>
				<UserInputType>TextBox</UserInputType>
			</ClaimType>			

			<ClaimType Id="ropc_grant_type">
				<DisplayName>ropc_grant_type</DisplayName>
				<DataType>string</DataType>
				<AdminHelpText>ropc_grant_type</AdminHelpText>
				<UserHelpText>ropc_grant_type</UserHelpText>
			</ClaimType>

			<ClaimType Id="ciam_client_id">
				<DisplayName>ciam_client_id</DisplayName>
				<DataType>string</DataType>
				<AdminHelpText>ciam_client_id</AdminHelpText>
				<UserHelpText>ciam_client_id</UserHelpText>
			</ClaimType>

			<ClaimType Id="readOnlystrongAuthenticationPhoneNumber">
				<DisplayName>Phone number</DisplayName>
				<DataType>string</DataType>
				<Mask Type="Simple">XXX-XXX-</Mask>
				<UserHelpText>Your telephone number</UserHelpText>
				<UserInputType>Readonly</UserInputType>
			</ClaimType>

			<ClaimType Id="countryCode">
				<DisplayName>Country</DisplayName>
				<DataType>string</DataType>
				<UserHelpText>Enter Country</UserHelpText>
				<UserInputType>DropdownSingleSelect</UserInputType>
				<Restriction>
					<Enumeration Text="New Zealand(+64)" Value="NZ" />
					<Enumeration Text="Ireland(+353)" Value="IE" />
					<Enumeration Text="Sweden(+46)" Value="SE" />
					<Enumeration Text="Switzerland(+41)" Value="CH" />
					<Enumeration Text="United Kingdom(+44)" Value="GB" />
					<Enumeration Text="United States(+1)" Value="US" />
				</Restriction>
			</ClaimType>

			<ClaimType Id="nationalNumber">
				<DisplayName>Phone Number</DisplayName>
				<DataType>string</DataType>
				<UserHelpText>Enter National Phone Number</UserHelpText>
				<UserInputType>TextBox</UserInputType>
				<PredicateValidationReference Id="nationalNumber" />
			</ClaimType>

			<ClaimType Id="verificationCode">
				<DisplayName>Verification Code</DisplayName>
				<DataType>string</DataType>
				<UserHelpText>Enter your verification code</UserHelpText>
				<UserInputType>TextBox</UserInputType>
			</ClaimType>

			<ClaimType Id="isForgotPassword">
				<DisplayName>Indicates whether the user selected Forgot Password</DisplayName>
				<DataType>boolean</DataType>
				<AdminHelpText></AdminHelpText>
			  </ClaimType>

		</ClaimsSchema>

		<Predicates>
			<Predicate Id="email" Method="MatchesRegex">
				<UserHelpText>Please enter a valid email address.</UserHelpText>
				<Parameters>
					<!--
            This regex is constructed mostly from RFC 5322 for email, with intentional omissions based on
					discovery of characters that don't work for other services we use
            # the below two lines cover the local part of the email, before the '@' sign
            [a-zA-Z0-9!#$%&amp;'+^_`{}~-]+         # matches lower or upper case letters, digits, and certain special
					characters
            (?:\.[a-zA-Z0-9!#$%&amp;'+^_`{}~-]+)*  # same list as above, but including an optional '.' character
					at the beginning, repeated
            # together, the above two lines prevent the '.' character from appearing at the start, end, or
					twice in a row in the local part
            @                                      # the '@' symbol appears exactly once, seperating the local and domain sections
            (?:[a-zA-Z0-9]                         # matches lower and uppercase letters and digits
            (?:[a-zA-Z0-9-]*                       # same as above, but also allowing '-'
            [a-zA-Z0-9])                           # only lower and uppercase letters and digits again
            ?\.)+                                  # allows for a '.' character to terminate a section
            # the above lines mean that '.' can create segments, and segments can't begin or end with a '-'.
					Also, no repeating '.' chars
            [a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?$
            # the above line is the essentially same as the previous section, but forces the email to not end
					with a '.'
          -->
					<Parameter Id="RegularExpression">^[a-zA-Z0-9!#$%&amp;'+^_`{}~-]+(?:\.[a-zA-Z0-9!#$%&amp;'+^_`{}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?$</Parameter>
				</Parameters>
			</Predicate>

			<Predicate Id="internationalOrNationalPhoneNumber" Method="MatchesRegex">
				<UserHelpText>The value entered needs to be a phone number.</UserHelpText>
				<Parameters>
					<!--
              This regex will match a string with an optional leading "+", 4 to 16 digits, and any number of
					dashes, parentheses, and spaces, in any order.
              It is intentionally overinclusive to allow the user to continue their journey with any input that
					might be an international or national phone number 
              in any country with any customary punctuation/formatting. In this policy, the
					ConvertStringToPhoneNumberClaim claims converter will do the the final
					validation, 
              ignoring the dashes, parentheses, and spaces.
            -->
					<Parameter Id="RegularExpression">^\+?(?:[-()\s]*\d[-()\s]*){4,16}$</Parameter>
				</Parameters>
			</Predicate>

			<Predicate Id="noLeadingPlus" Method="MatchesRegex">
				<UserHelpText>The national number should not include a country code.</UserHelpText>
				<Parameters>
					<!-- Combine this with the predicate above to match only a national phone number -->
					<Parameter Id="RegularExpression">^[^\\+]+$</Parameter>
				</Parameters>
			</Predicate>
		</Predicates>

		<PredicateValidations>
			<PredicateValidation Id="nationalNumber">
				<PredicateGroups>
					<PredicateGroup Id="internationalOrNationalPhoneNumber">
						<PredicateReferences>
							<PredicateReference Id="internationalOrNationalPhoneNumber" />
						</PredicateReferences>
					</PredicateGroup>
					<PredicateGroup Id="noLeadingPlus">
						<PredicateReferences>
							<PredicateReference Id="noLeadingPlus" />
						</PredicateReferences>
					</PredicateGroup>
				</PredicateGroups>
			</PredicateValidation>

			<PredicateValidation Id="internationalOrNationalPhoneNumber">
				<PredicateGroups>
					<PredicateGroup Id="internationalOrNationalPhoneNumber">
						<UserHelpText>Please enter a valid phone number.</UserHelpText>
						<PredicateReferences>
							<PredicateReference Id="internationalOrNationalPhoneNumber" />
						</PredicateReferences>
					</PredicateGroup>
				</PredicateGroups>
			</PredicateValidation>
		</PredicateValidations>

		<ClaimsTransformations>

			<ClaimsTransformation Id="CopyPhoneToReadOnly" TransformationMethod="FormatStringClaim">
				<InputClaims>
					<InputClaim ClaimTypeReferenceId="phoneNumberString"
						TransformationClaimType="inputClaim" />
				</InputClaims>
				<InputParameters>
					<InputParameter Id="stringFormat" DataType="string" Value="{0}" />
				</InputParameters>
				<OutputClaims>
					<OutputClaim ClaimTypeReferenceId="readOnlystrongAuthenticationPhoneNumber"
						TransformationClaimType="outputClaim" />
				</OutputClaims>
			</ClaimsTransformation>

			<ClaimsTransformation Id="PhoneNumberToString"
				TransformationMethod="ConvertPhoneNumberClaimToString">
				<InputClaims>
					<InputClaim ClaimTypeReferenceId="signInNames.phoneNumber"
						TransformationClaimType="phoneNumber" />
				</InputClaims>
				<OutputClaims>
					<OutputClaim ClaimTypeReferenceId="phoneNumberString"
						TransformationClaimType="phoneNumberString" />
				</OutputClaims>
			</ClaimsTransformation>

			<ClaimsTransformation Id="ConvertStringToPhoneNumber"
				TransformationMethod="ConvertStringToPhoneNumberClaim">
				<InputClaims>
					<InputClaim ClaimTypeReferenceId="countryCode" TransformationClaimType="country" />
					<InputClaim ClaimTypeReferenceId="nationalNumber"
						TransformationClaimType="phoneNumberString" />
				</InputClaims>
				<OutputClaims>
					<OutputClaim ClaimTypeReferenceId="signInNames.phoneNumber"
						TransformationClaimType="outputClaim" />
				</OutputClaims>
			</ClaimsTransformation>

			<ClaimsTransformation Id="CIAM-CreateUserPrincipalName"
				TransformationMethod="FormatStringClaim">
				<InputClaims>
					<InputClaim ClaimTypeReferenceId="upnUserName"
						TransformationClaimType="inputClaim" />
				</InputClaims>
				<InputParameters>
					<InputParameter Id="stringFormat" DataType="string"
						Value="cpim_{0}@external_tenant.onmicrosoft.com" />
				</InputParameters>
				<OutputClaims>
					<OutputClaim ClaimTypeReferenceId="userPrincipalName"
						TransformationClaimType="outputClaim" />
				</OutputClaims>
			</ClaimsTransformation>
			
		</ClaimsTransformations>

		<ContentDefinitions>
			<ContentDefinition Id="api.error">
				<LoadUri>~/tenant/templates/AzureBlue/exception.cshtml</LoadUri>
				<DataUri>urn:com:microsoft:aad:b2c:elements:contract:globalexception:1.2.0</DataUri>
			</ContentDefinition>
			<ContentDefinition Id="api.idpselections">
				<LoadUri>~/tenant/templates/AzureBlue/idpSelector.cshtml</LoadUri>
				<DataUri>urn:com:microsoft:aad:b2c:elements:contract:providerselection:1.2.0</DataUri>
			</ContentDefinition>
			<ContentDefinition Id="api.idpselections.signup">
				<LoadUri>~/tenant/templates/AzureBlue/idpSelector.cshtml</LoadUri>
				<DataUri>urn:com:microsoft:aad:b2c:elements:contract:providerselection:1.2.0</DataUri>
			</ContentDefinition>
			<ContentDefinition Id="api.signuporsignin">
				<LoadUri>~/tenant/templates/AzureBlue/unified.cshtml</LoadUri>
				<DataUri>urn:com:microsoft:aad:b2c:elements:contract:unifiedssp:2.1.2</DataUri>
			</ContentDefinition>
			<ContentDefinition Id="api.selfasserted">
				<LoadUri>~/tenant/templates/AzureBlue/selfAsserted.cshtml</LoadUri>
				<DataUri>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:1.2.0</DataUri>
			</ContentDefinition>
			<ContentDefinition Id="api.selfasserted.profileupdate">
				<LoadUri>~/tenant/templates/AzureBlue/selfAsserted.cshtml</LoadUri>
				<DataUri>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:1.2.0</DataUri>
			</ContentDefinition>
			<ContentDefinition Id="api.localaccountsignup">
				<LoadUri>~/tenant/templates/AzureBlue/selfAsserted.cshtml</LoadUri>
				<DataUri>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:1.2.0</DataUri>
			</ContentDefinition>
			<ContentDefinition Id="api.localaccountpasswordreset">
				<LoadUri>~/tenant/templates/AzureBlue/selfAsserted.cshtml</LoadUri>
				<DataUri>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:1.2.0</DataUri>
			</ContentDefinition>
			<ContentDefinition Id="api.phonefactor">
				<LoadUri>~/tenant/templates/AzureBlue/multifactor-1.0.0.cshtml</LoadUri>
				<DataUri>urn:com:microsoft:aad:b2c:elements:contract:multifactor:1.2.0</DataUri>
			</ContentDefinition>
			<ContentDefinition Id="newPhoneNumber">
				<LoadUri>~/tenant/templates/AzureBlue/selfAsserted.cshtml</LoadUri>
				<RecoveryUri>~/common/default_page_error.html</RecoveryUri>
				<DataUri>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:2.1.1</DataUri>
				<Metadata>
					<Item Key="DisplayName">Verify new phone number</Item>
				</Metadata>
			</ContentDefinition>
		</ContentDefinitions>

		<DisplayControls>
			<DisplayControl Id="phoneVerificationControl"
				UserInterfaceControlType="VerificationControl">
				<InputClaims>
					<InputClaim ClaimTypeReferenceId="nationalNumber" />
					<InputClaim ClaimTypeReferenceId="countryCode" />
				</InputClaims>
				<DisplayClaims>
					<DisplayClaim ClaimTypeReferenceId="countryCode" ControlClaimType="CountryCode"
						Required="true" />
					<DisplayClaim ClaimTypeReferenceId="nationalNumber" ControlClaimType="Phone"
						Required="true" />
					<DisplayClaim ClaimTypeReferenceId="verificationCode"
						ControlClaimType="VerificationCode" Required="true" />
				</DisplayClaims>
				<Actions>
					<Action Id="SendCode">
						<ValidationClaimsExchange>
							<ValidationClaimsExchangeTechnicalProfile
								TechnicalProfileReferenceId="CombineCountryCodeAndNationalNumber" />
							<ValidationClaimsExchangeTechnicalProfile
								TechnicalProfileReferenceId="AzureMfa-SendSms" />
						</ValidationClaimsExchange>
					</Action>
					<Action Id="VerifyCode">
						<ValidationClaimsExchange>
							<ValidationClaimsExchangeTechnicalProfile
								TechnicalProfileReferenceId="CombineCountryCodeAndNationalNumber" />
							<ValidationClaimsExchangeTechnicalProfile
								TechnicalProfileReferenceId="AzureMfa-VerifySms" />
						</ValidationClaimsExchange>
					</Action>
				</Actions>
			</DisplayControl>

			<DisplayControl Id="phoneVerificationControl-readOnly"
				UserInterfaceControlType="VerificationControl">
				<InputClaims>
					<InputClaim ClaimTypeReferenceId="readOnlystrongAuthenticationPhoneNumber" />
				</InputClaims>
				<DisplayClaims>
					<DisplayClaim ClaimTypeReferenceId="readOnlystrongAuthenticationPhoneNumber"
						Required="true" />
					<DisplayClaim ClaimTypeReferenceId="verificationCode"
						ControlClaimType="VerificationCode" Required="true" />
				</DisplayClaims>
				<OutputClaims>
					<OutputClaim ClaimTypeReferenceId="phoneNumberString" />
				</OutputClaims>
				<Actions>
					<Action Id="SendCode">
						<ValidationClaimsExchange>
							<ValidationClaimsExchangeTechnicalProfile
								TechnicalProfileReferenceId="AzureMfa-SendSms-RO" />
						</ValidationClaimsExchange>
					</Action>
					<Action Id="VerifyCode">
						<ValidationClaimsExchange>
							<ValidationClaimsExchangeTechnicalProfile
								TechnicalProfileReferenceId="AzureMfa-VerifySms-RO" />
						</ValidationClaimsExchange>
					</Action>
				</Actions>
			</DisplayControl>
		</DisplayControls>
	</BuildingBlocks>

	<!-- 
	CIAM-SignUpWithLogonEmail 					- LocalAccountSignUpWithLogonEmail
	CIAM-SelfAsserted-LocalAccountSignin-Email 	- SelfAsserted-LocalAccountSignin-Email
	REST-CIAM-UserReadUsingObjectIdOrEmail 		- AAD-UserReadUsingObjectId
	REST-CIAM-UserReadUsingAlternativeSecurityId - AAD-UserReadUsingAlternativeSecurityId
	CIAM-SelfAsserted-SocialLogin-Email 		- SelfAsserted-SocialLogin-Email	
	REST-CIAM-UserWriteUsingAlternativeSecurityId - AAD-UserWriteUsingAlternativeSecurityId

	REST-CIAM-UserWriteUsingLogonEmail			- AAD-UserWriteUsingLogonEmail
	REST-login-NonInteractive-CIAM 				- login-NonInteractive
	REST-fetchUserProfile-CIAM 
	REST-CIAM-UserUpdatePhoneNumberUsingObjectId - AAD-UserWritePhoneNumberUsingObjectId
	
	-->


	<ClaimsProviders>

		<ClaimsProvider>
			<Domain>google.com</Domain>
			<DisplayName>Google</DisplayName>
			<TechnicalProfiles>
				<TechnicalProfile Id="Google-OAuth2">
					<DisplayName>Google</DisplayName>
					<Protocol Name="OAuth2" />
					<Metadata>
						<Item Key="ProviderName">google</Item>
						<Item Key="authorization_endpoint">https://accounts.google.com/o/oauth2/auth</Item>
						<Item Key="AccessTokenEndpoint">https://accounts.google.com/o/oauth2/token</Item>
						<Item Key="ClaimsEndpoint">https://www.googleapis.com/oauth2/v1/userinfo</Item>
						<Item Key="scope">email profile</Item>
						<Item Key="HttpBinding">POST</Item>
						<Item Key="UsePolicyInRedirectUri">false</Item>
						<Item Key="client_id">606...ktp.apps.googleusercontent.com</Item>
					</Metadata>
					<CryptographicKeys>
						<Key Id="client_secret" StorageReferenceId="B2C_1A_GoogleSecret" />
					</CryptographicKeys>
					<OutputClaims>
						<OutputClaim ClaimTypeReferenceId="issuerUserId" PartnerClaimType="id" />
						<OutputClaim ClaimTypeReferenceId="email" PartnerClaimType="email" />
						<OutputClaim ClaimTypeReferenceId="givenName" PartnerClaimType="given_name" />
						<OutputClaim ClaimTypeReferenceId="surname" PartnerClaimType="family_name" />
						<OutputClaim ClaimTypeReferenceId="displayName" PartnerClaimType="name" />
						<OutputClaim ClaimTypeReferenceId="identityProvider"
							DefaultValue="google.com" />
						<OutputClaim ClaimTypeReferenceId="authenticationSource"
							DefaultValue="socialIdpAuthentication" />
					</OutputClaims>
					<OutputClaimsTransformations>
						<OutputClaimsTransformation ReferenceId="CreateRandomUPNUserName" />
						<OutputClaimsTransformation ReferenceId="CIAM-CreateUserPrincipalName" />
						<OutputClaimsTransformation ReferenceId="CreateAlternativeSecurityId" />
						<OutputClaimsTransformation
							ReferenceId="CreateSubjectClaimFromAlternativeSecurityId" />
					</OutputClaimsTransformations>
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-SocialLogin" />
				</TechnicalProfile>
			</TechnicalProfiles>
		</ClaimsProvider>

		<!-- SUSI/Account Link/ForgotPwd journey forwarder -->
		<ClaimsProvider>
			<DisplayName>Local account sign up and sign in</DisplayName>
			<TechnicalProfiles>
				<TechnicalProfile Id="CIAM-SignUpWithLogonEmail">
					<DisplayName>Email signup</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<Item Key="IpAddressClaimReferenceId">IpAddress</Item>
						<Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
					</Metadata>
					<CryptographicKeys>
						<Key Id="issuer_secret" StorageReferenceId="B2C_1A_TokenSigningKeyContainer" />
					</CryptographicKeys>
					<InputClaims>
						<InputClaim ClaimTypeReferenceId="email" />
					</InputClaims>
					<DisplayClaims>
						<DisplayClaim ClaimTypeReferenceId="email" Required="true" />
						<DisplayClaim ClaimTypeReferenceId="newPassword" Required="true" />
						<DisplayClaim ClaimTypeReferenceId="reenterPassword" Required="true" />
						<DisplayClaim ClaimTypeReferenceId="displayName" />
						<DisplayClaim ClaimTypeReferenceId="givenName" />
						<DisplayClaim ClaimTypeReferenceId="surName" />
					</DisplayClaims>
					<OutputClaims>
						<OutputClaim ClaimTypeReferenceId="objectId" />
						<OutputClaim ClaimTypeReferenceId="email" Required="true" />
						<OutputClaim ClaimTypeReferenceId="newPassword" Required="true" />
						<OutputClaim ClaimTypeReferenceId="reenterPassword" Required="true" />
						<OutputClaim ClaimTypeReferenceId="executed-SelfAsserted-Input"
							DefaultValue="true" />
						<OutputClaim ClaimTypeReferenceId="authenticationSource"
							DefaultValue="localAccountAuthentication" />
						<OutputClaim ClaimTypeReferenceId="newUser" DefaultValue="true" />

						<!-- Optional claims, to be collected from the user -->
						<OutputClaim ClaimTypeReferenceId="displayName" />
						<OutputClaim ClaimTypeReferenceId="givenName" />
						<OutputClaim ClaimTypeReferenceId="surName" />
					</OutputClaims>
					<ValidationTechnicalProfiles>
						<ValidationTechnicalProfile ReferenceId="REST-CIAM-UserWriteUsingLogonEmail" />
					</ValidationTechnicalProfiles>
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-AAD" />
				</TechnicalProfile>

				<TechnicalProfile Id="CIAM-SelfAsserted-LocalAccountSignin-Email">
					<DisplayName>Local Account Signin</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<Item Key="SignUpTarget">SignUpWithLogonEmailExchange</Item>						
						<Item Key="setting.operatingMode">Email</Item>
						<Item Key="ContentDefinitionReferenceId">api.localaccountsignin</Item>
						<Item Key="IncludeClaimResolvingInClaimsHandling">true</Item>
						<Item Key="setting.forgotPasswordLinkOverride">ForgotPasswordExchange</Item>
					</Metadata>
					<IncludeInSso>false</IncludeInSso>
					<InputClaims>
						<InputClaim ClaimTypeReferenceId="signInName" />
					</InputClaims>
					<OutputClaims>
						<OutputClaim ClaimTypeReferenceId="signInName" Required="true" />
						<OutputClaim ClaimTypeReferenceId="email" />
						<OutputClaim ClaimTypeReferenceId="password" Required="true" />
						<OutputClaim ClaimTypeReferenceId="objectId" />
						<OutputClaim ClaimTypeReferenceId="authenticationSource"
							DefaultValue="localAccountAuthentication" />
						<OutputClaim ClaimTypeReferenceId="graph_bearerToken" />
					</OutputClaims>
					<ValidationTechnicalProfiles>
						<ValidationTechnicalProfile ReferenceId="REST-login-NonInteractive-CIAM" />
						<ValidationTechnicalProfile ReferenceId="REST-fetchUserProfile-CIAM" />
					</ValidationTechnicalProfiles>
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-AAD" />
				</TechnicalProfile>
			</TechnicalProfiles>
		</ClaimsProvider>

		<ClaimsProvider>
			<DisplayName>Local Account Sign Up and Sign in MFA controls</DisplayName>
			<TechnicalProfiles>
				<TechnicalProfile Id="SelfAsserted-Enrol-MFA">
					<DisplayName>Phone</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<Item Key="ContentDefinitionReferenceId">newPhoneNumber</Item>
						<Item Key="UserMessageIfClaimsTransformationInvalidPhoneNumber">Please enter a valid phone number and country code.</Item>
					</Metadata>
					<CryptographicKeys>
						<Key Id="issuer_secret" StorageReferenceId="B2C_1A_TokenSigningKeyContainer" />
					</CryptographicKeys>					
					<DisplayClaims>
						<DisplayClaim DisplayControlReferenceId="phoneVerificationControl" />
					</DisplayClaims>
					<OutputClaims>
						<OutputClaim ClaimTypeReferenceId="userPrincipalName" />
						<OutputClaim ClaimTypeReferenceId="displayName" />
						<OutputClaim ClaimTypeReferenceId="givenName" />
						<OutputClaim ClaimTypeReferenceId="surName" />
						<OutputClaim ClaimTypeReferenceId="signInNames.phoneNumber" />
						<OutputClaim ClaimTypeReferenceId="newlyEnrolled" DefaultValue="true" />
					</OutputClaims>
					<ValidationTechnicalProfiles>
						<ValidationTechnicalProfile
							ReferenceId="CombineCountryCodeAndNationalNumber" />
						<ValidationTechnicalProfile
							ReferenceId="REST-CIAM-UserUpdatePhoneNumberUsingObjectId" />
					</ValidationTechnicalProfiles>
				</TechnicalProfile>

				<TechnicalProfile Id="SelfAsserted-MFA-Challenge">
					<DisplayName>Phone</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<Item Key="ContentDefinitionReferenceId">newPhoneNumber</Item>
						<Item Key="UserMessageIfClaimsTransformationInvalidPhoneNumber">Please enter a valid phone number and country code.</Item>
					</Metadata>
					<CryptographicKeys>
						<Key Id="issuer_secret" StorageReferenceId="B2C_1A_TokenSigningKeyContainer" />
					</CryptographicKeys>
					<InputClaimsTransformations>						
						<InputClaimsTransformation ReferenceId="CopyPhoneToReadOnly" />
					</InputClaimsTransformations>
					<DisplayClaims>
						<DisplayClaim DisplayControlReferenceId="phoneVerificationControl-ReadOnly" />
					</DisplayClaims>
					<OutputClaims>
						<OutputClaim ClaimTypeReferenceId="userPrincipalName" />
						<OutputClaim ClaimTypeReferenceId="displayName" />
						<OutputClaim ClaimTypeReferenceId="givenName" />
						<OutputClaim ClaimTypeReferenceId="surName" />
						<OutputClaim ClaimTypeReferenceId="signInNames.phoneNumber" />
					</OutputClaims>
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-MFA" />
				</TechnicalProfile>

				<TechnicalProfile Id="SM-MFA">
					<PersistedClaims>
						<PersistedClaim ClaimTypeReferenceId="signInNames.phoneNumber" />
					</PersistedClaims>
				</TechnicalProfile>

				<TechnicalProfile Id="CombineCountryCodeAndNationalNumber">
					<DisplayName>Combine country code and national number</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.ClaimsTransformationProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<InputClaimsTransformations>
						<InputClaimsTransformation ReferenceId="ConvertStringToPhoneNumber" />
					</InputClaimsTransformations>
					<OutputClaims>
						<OutputClaim ClaimTypeReferenceId="signInNames.phoneNumber" />
					</OutputClaims>
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
				</TechnicalProfile>				

				<TechnicalProfile Id="AzureMfa-SendSms-RO">
					<DisplayName>Send Sms</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.AzureMfaProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<Item Key="Operation">OneWaySMS</Item>
					</Metadata>
					<InputClaims>
						<InputClaim ClaimTypeReferenceId="userPrincipalName"
							DefaultValue="test@tenant.onmicrosoft.com" />
						<InputClaim ClaimTypeReferenceId="readOnlystrongAuthenticationPhoneNumber"
							PartnerClaimType="phoneNumber" />
					</InputClaims>
				</TechnicalProfile>

				<TechnicalProfile Id="AzureMfa-VerifySms-RO">
					<DisplayName>Verify Sms</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.AzureMfaProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<Item Key="Operation">Verify</Item>
					</Metadata>
					<InputClaims>
						<InputClaim ClaimTypeReferenceId="verificationCode" />
						<InputClaim ClaimTypeReferenceId="readOnlystrongAuthenticationPhoneNumber"
							PartnerClaimType="phoneNumber" />
					</InputClaims>
				</TechnicalProfile>

				<TechnicalProfile Id="AzureMfa-SendSms">
					<DisplayName>Send Sms</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.AzureMfaProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<Item Key="Operation">OneWaySMS</Item>
					</Metadata>
					<InputClaims>
						<InputClaim ClaimTypeReferenceId="userPrincipalName"
							DefaultValue="test@tenant.onmicrosoft.com" />
						<InputClaim ClaimTypeReferenceId="signInNames.phoneNumber"
							PartnerClaimType="phoneNumber" />
					</InputClaims>
				</TechnicalProfile>

				<TechnicalProfile Id="AzureMfa-VerifySms">
					<DisplayName>Verify Sms</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.AzureMfaProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<Item Key="Operation">Verify</Item>
					</Metadata>
					<InputClaims>
						<InputClaim ClaimTypeReferenceId="verificationCode" />
						<InputClaim ClaimTypeReferenceId="signInNames.phoneNumber"
							PartnerClaimType="phoneNumber" />
					</InputClaims>
				</TechnicalProfile>
			</TechnicalProfiles>
		</ClaimsProvider>

		<ClaimsProvider>
			<DisplayName>Local Account Sign Up and Sign in APIs</DisplayName>
			<TechnicalProfiles>
				<TechnicalProfile Id="CIAM-SelfAsserted-Social">
					<DisplayName>User ID signup</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<Item Key="ContentDefinitionReferenceId">api.socialccountsignup</Item>
					</Metadata>
					<CryptographicKeys>
						<Key Id="issuer_secret" StorageReferenceId="B2C_1A_TokenSigningKeyContainer" />
					</CryptographicKeys>
					<InputClaims>
						<!-- These claims ensure that any values retrieved in the previous steps
						(e.g. from an external IDP) are prefilled. 
						   Note that some of these claims may not have any value, for example, if the external IDP did not
						provide any of
						   these values, or if the claim did not appear in the OutputClaims section of the IDP.
						   In addition, if a claim is not in the InputClaims section, but it is in the OutputClaims section,
						then its
						   value will not be prefilled, but the user will still be prompted for it (with an empty value). -->
						<InputClaim ClaimTypeReferenceId="displayName" />
						<InputClaim ClaimTypeReferenceId="givenName" />
						<InputClaim ClaimTypeReferenceId="surname" />
					</InputClaims>
					<DisplayClaims>
						<DisplayClaim ClaimTypeReferenceId="displayName" />
						<DisplayClaim ClaimTypeReferenceId="givenName" />
						<DisplayClaim ClaimTypeReferenceId="surname" />							
					</DisplayClaims>
					<OutputClaims>
						<!-- These claims are not shown to the user because their value is obtained
						through the "ValidationTechnicalProfiles"
						   referenced below, or a default value is assigned to the claim. A claim is only shown to the user to
						provide a 
						   value if its value cannot be obtained through any other means. -->
						<OutputClaim ClaimTypeReferenceId="objectId" />
						<OutputClaim ClaimTypeReferenceId="newUser" />
						<OutputClaim ClaimTypeReferenceId="executed-SelfAsserted-Input"
							DefaultValue="true" />

						<!-- Optional claims. These claims are collected from the user and can be
						modified. If a claim is to be persisted in the directory after having been 
						   collected from the user, it needs to be added as a PersistedClaim in the ValidationTechnicalProfile
						referenced below, i.e. 
						   in AAD-UserWriteUsingAlternativeSecurityId. -->
						<OutputClaim ClaimTypeReferenceId="displayName" />
						<OutputClaim ClaimTypeReferenceId="givenName" />
						<OutputClaim ClaimTypeReferenceId="surname" />
					</OutputClaims>
					<ValidationTechnicalProfiles>						
						<ValidationTechnicalProfile
						ReferenceId="REST-CIAM-UserWriteUsingAlternativeSecurityId" />
					</ValidationTechnicalProfiles>
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-SocialSignup" />
				</TechnicalProfile>				
				
				<TechnicalProfile Id="CIAM-LocalAccountDiscoveryUsingEmailAddress">
					<DisplayName>Email signup</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<Item Key="IpAddressClaimReferenceId">IpAddress</Item>						
						<Item Key="ContentDefinitionReferenceId">api.selfasserted</Item>
					</Metadata>
					<CryptographicKeys>
						<Key Id="issuer_secret" StorageReferenceId="B2C_1A_TokenSigningKeyContainer" />
					</CryptographicKeys>
					<DisplayClaims>
						<DisplayClaim ClaimTypeReferenceId="email" Required="true" />						
					</DisplayClaims>
					<OutputClaims>
						<OutputClaim ClaimTypeReferenceId="objectId" />
						<OutputClaim ClaimTypeReferenceId="email" Required="true" />						
						<OutputClaim ClaimTypeReferenceId="executed-SelfAsserted-Input"
							DefaultValue="true" />
						<OutputClaim ClaimTypeReferenceId="authenticationSource"
							DefaultValue="localAccountAuthentication" />						
					</OutputClaims>					
					<ValidationTechnicalProfiles>						
						<ValidationTechnicalProfile ReferenceId="REST-CIAM-UserReadUsingObjectIdOrEmail" />
					</ValidationTechnicalProfiles>
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-AAD" />
				</TechnicalProfile>

				<TechnicalProfile Id="SelfAsserted-Error-MFA">
					<DisplayName>Error message</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<Item Key="ContentDefinitionReferenceId">api.selfasserted</Item>
						<Item Key="setting.showContinueButton">false</Item>
						<Item Key="setting.showCancelButton">false</Item>
					</Metadata>
					<InputClaims>
						<InputClaim ClaimTypeReferenceId="errorMessage" DefaultValue="You need to proof up - contact support"
							AlwaysUseDefaultValue="true" />
					</InputClaims>
					<OutputClaims>
						<OutputClaim ClaimTypeReferenceId="errorMessage" />
					</OutputClaims>
				</TechnicalProfile>				

				<TechnicalProfile Id="CIAM-LocalAccountWritePasswordUsingObjectId">
					<DisplayName>Change password (username)</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<Item Key="ContentDefinitionReferenceId">api.localaccountpasswordreset</Item>
					</Metadata>
					<CryptographicKeys>
						<Key Id="issuer_secret" StorageReferenceId="B2C_1A_TokenSigningKeyContainer" />
					</CryptographicKeys>
					<InputClaims>
						<InputClaim ClaimTypeReferenceId="objectId" />
						<InputClaim ClaimTypeReferenceId="Verified.strongAuthenticationPhoneNumber" />
					</InputClaims>
					<OutputClaims>
						<OutputClaim ClaimTypeReferenceId="newPassword" Required="true" />
						<OutputClaim ClaimTypeReferenceId="reenterPassword" Required="true" />
					</OutputClaims>
					<ValidationTechnicalProfiles>
						<ValidationTechnicalProfile
							ReferenceId="REST-CIAM-UserWritePasswordUsingObjectId" />
					</ValidationTechnicalProfiles>
				</TechnicalProfile>

				<TechnicalProfile Id="CIAM_SelfAsserted-ProfileUpdate">
					<DisplayName>User ID update</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<Item Key="ContentDefinitionReferenceId">api.selfasserted.profileupdate</Item>						
					</Metadata>
					<IncludeInSso>false</IncludeInSso>
					<InputClaims>
						<InputClaim ClaimTypeReferenceId="alternativeSecurityId" />
						<InputClaim ClaimTypeReferenceId="userPrincipalName" />						
						<InputClaim ClaimTypeReferenceId="displayName" />
						<InputClaim ClaimTypeReferenceId="givenName" />
						<InputClaim ClaimTypeReferenceId="surname" />
					</InputClaims>
					<OutputClaims>
						<!-- Required claims -->
						<OutputClaim ClaimTypeReferenceId="executed-SelfAsserted-Input"
							DefaultValue="true" />						
						<OutputClaim ClaimTypeReferenceId="displayName" />
						<OutputClaim ClaimTypeReferenceId="givenName" />
						<OutputClaim ClaimTypeReferenceId="surname" />
					</OutputClaims>					
				</TechnicalProfile>

				<!-- Forgot password -->

				<!-- Set the isForgotPassword to true-->
				<TechnicalProfile Id="ForgotPassword">
					<DisplayName>Forgot your password?</DisplayName>
					<Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.ClaimsTransformationProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<OutputClaims>
					  <OutputClaim ClaimTypeReferenceId="isForgotPassword" DefaultValue="true" AlwaysUseDefaultValue="true" />
					</OutputClaims>
				  </TechnicalProfile>				  
		  
				  <!-- Adding the required session manager -->
				  <TechnicalProfile Id="LocalAccountWritePasswordUsingObjectId">
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-AAD" />
				  </TechnicalProfile>

				<!-- REST API -->

				<TechnicalProfile Id="REST-CIAM-UserReadUsingObjectIdOrEmail">
					<DisplayName>Write user into CIAM tenant</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<!-- Set the ServiceUrl with your own REST API endpoint -->
						<Item Key="ServiceUrl">https://496c-222-152-99-121.ngrok-free.app/api/ciamhelper</Item>
						<Item Key="SendClaimsIn">Body</Item>
						<!-- Set AuthenticationType to Basic or ClientCertificate in production
						environments -->
						<Item Key="AuthenticationType">None</Item>
						<!-- REMOVE the following line in production environments -->
						<Item Key="AllowInsecureAuthInProduction">true</Item>
					</Metadata>
					<InputClaims>
						<!-- Claims sent to your REST API -->
						<InputClaim ClaimTypeReferenceId="objectId" />
						<InputClaim ClaimTypeReferenceId="email" />
						<InputClaim ClaimTypeReferenceId="method" AlwaysUseDefaultValue="true"
							DefaultValue="read" />
					</InputClaims>
					<OutputClaims>
						<!-- Claims parsed from your REST API -->
						<OutputClaim ClaimTypeReferenceId="objectId" PartnerClaimType="Id" /> 
						<OutputClaim ClaimTypeReferenceId="signInNames.emailAddress"
							PartnerClaimType="identities.0.issuerAssignedId" />
						<OutputClaim ClaimTypeReferenceId="displayName"
							PartnerClaimType="DisplayName" />						
						<OutputClaim ClaimTypeReferenceId="otherMails" PartnerClaimType="otherMails" />
						<OutputClaim ClaimTypeReferenceId="givenName" PartnerClaimType="GivenName" />
						<OutputClaim ClaimTypeReferenceId="surname" PartnerClaimType="Surname" />
						<OutputClaim ClaimTypeReferenceId="userPrincipalName" PartnerClaimType="UserPrincipalName" />
					</OutputClaims>
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
				</TechnicalProfile>

				<TechnicalProfile Id="REST-CIAM-UserReadUsingAlternativeSecurityId">
					<DisplayName>Write user into CIAM tenant</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<!-- Set the ServiceUrl with your own REST API endpoint -->
						<Item Key="ServiceUrl">https://496c-222-152-99-121.ngrok-free.app/api/ciamhelper</Item>
						<Item Key="SendClaimsIn">Body</Item>
						<!-- Set AuthenticationType to Basic or ClientCertificate in production
						environments -->
						<Item Key="AuthenticationType">None</Item>
						<!-- REMOVE the following line in production environments -->
						<Item Key="AllowInsecureAuthInProduction">true</Item>
					</Metadata>
					<InputClaims>
						<!-- Claims sent to your REST API -->
						<InputClaim ClaimTypeReferenceId="issuerUserId" />
						<InputClaim ClaimTypeReferenceId="identityProvider" />
						<InputClaim ClaimTypeReferenceId="method" AlwaysUseDefaultValue="true"
							DefaultValue="readAlternativeSecurityId" />
					</InputClaims>
					<OutputClaims>
						<!-- Claims parsed from your REST API -->						
						<!-- Required claims -->
						<OutputClaim ClaimTypeReferenceId="objectId" PartnerClaimType="Id" />
						<OutputClaim ClaimTypeReferenceId="strongAuthenticationPhoneNumber" />
						<!-- Optional claims -->
						<OutputClaim ClaimTypeReferenceId="userPrincipalName"
							PartnerClaimType="UserPrincipalName" />
						<OutputClaim ClaimTypeReferenceId="displayName"
							PartnerClaimType="DisplayName" />
						<OutputClaim ClaimTypeReferenceId="email" PartnerClaimType="Mail" />
						<OutputClaim ClaimTypeReferenceId="otherMails" />
						<OutputClaim ClaimTypeReferenceId="givenName" PartnerClaimType="GivenName" />
						<OutputClaim ClaimTypeReferenceId="surname" PartnerClaimType="Surname" />
					</OutputClaims>
					<IncludeTechnicalProfile ReferenceId="AAD-Common" />
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-AAD" />
				</TechnicalProfile>

				<TechnicalProfile Id="REST-CIAM-UserWriteUsingLogonEmail">
					<DisplayName>Write user into CIAM tenant</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<!-- Set the ServiceUrl with your own REST API endpoint -->
						<Item Key="ServiceUrl">https://496c-222-152-99-121.ngrok-free.app/api/ciamhelper</Item>
						<Item Key="SendClaimsIn">Body</Item>
						<!-- Set AuthenticationType to Basic or ClientCertificate in production
						environments -->
						<Item Key="AuthenticationType">None</Item>
						<!-- REMOVE the following line in production environments -->
						<Item Key="AllowInsecureAuthInProduction">true</Item>
					</Metadata>
					<InputClaims>
						<!-- Claims sent to your REST API -->
						<InputClaim ClaimTypeReferenceId="email" />
						<InputClaim ClaimTypeReferenceId="newPassword" PartnerClaimType="password" />
						<InputClaim ClaimTypeReferenceId="displayName" />
						<InputClaim ClaimTypeReferenceId="givenName" />
						<InputClaim ClaimTypeReferenceId="surName" />
						<InputClaim ClaimTypeReferenceId="method" AlwaysUseDefaultValue="true"
							DefaultValue="createUser" />
					</InputClaims>
					<OutputClaims>
						<!-- Claims parsed from your REST API -->
						<OutputClaim ClaimTypeReferenceId="objectId" PartnerClaimType="id" />
						<OutputClaim ClaimTypeReferenceId="displayName" />
						<OutputClaim ClaimTypeReferenceId="givenName" />
						<OutputClaim ClaimTypeReferenceId="surName" />
					</OutputClaims>
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
				</TechnicalProfile>

				<TechnicalProfile Id="REST-CIAM-UserWriteUsingAlternativeSecurityId">
					<DisplayName>Write user into CIAM tenant</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<!-- Set the ServiceUrl with your own REST API endpoint -->
						<Item Key="ServiceUrl">https://496c-222-152-99-121.ngrok-free.app/api/ciamhelper</Item>
						<Item Key="SendClaimsIn">Body</Item>
						<!-- Set AuthenticationType to Basic or ClientCertificate in production
						environments -->
						<Item Key="AuthenticationType">None</Item>
						<!-- REMOVE the following line in production environments -->
						<Item Key="AllowInsecureAuthInProduction">true</Item>
					</Metadata>
					<InputClaims>
						<!-- Claims sent to your REST API -->
						<InputClaim ClaimTypeReferenceId="objectId" />
						<InputClaim ClaimTypeReferenceId="identityProvider" />
						<InputClaim ClaimTypeReferenceId="issuerUserId" />
						<InputClaim ClaimTypeReferenceId="email" />						
						<InputClaim ClaimTypeReferenceId="mailNickName" DefaultValue="unknown" />
						<InputClaim ClaimTypeReferenceId="userPrincipalName" PartnerClaimType="upn" />
						<InputClaim ClaimTypeReferenceId="displayName" DefaultValue="unknown" />
						<InputClaim ClaimTypeReferenceId="givenName" />
						<InputClaim ClaimTypeReferenceId="surName" />
						<InputClaim ClaimTypeReferenceId="method" AlwaysUseDefaultValue="true"
							DefaultValue="writeAlternativeSecurityId" />
					</InputClaims>
					<OutputClaims>
						<!-- Claims parsed from your REST API -->
						<OutputClaim ClaimTypeReferenceId="objectId" PartnerClaimType="id" />
						<OutputClaim ClaimTypeReferenceId="displayName" />
						<OutputClaim ClaimTypeReferenceId="givenName" />
						<OutputClaim ClaimTypeReferenceId="surName" />
						<!-- <OutputClaim ClaimTypeReferenceId="objectId" /> -->
						<OutputClaim ClaimTypeReferenceId="newUser"
							PartnerClaimType="newClaimsPrincipalCreated" />
						<!-- The following other mails claim is needed for the case when a user is
						created, we get otherMails from directory. Self-asserted provider also has
						an  OutputClaims, and if this is absent, Self-Asserted provider will prompt the user for otherMails. -->
						<OutputClaim ClaimTypeReferenceId="otherMails" />
					</OutputClaims>
					<IncludeTechnicalProfile ReferenceId="AAD-Common" />
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-AAD" />
				</TechnicalProfile>

				<TechnicalProfile Id="REST-login-NonInteractive-CIAM">
					<DisplayName>non interactive authentication to APAC</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<Item Key="ServiceUrl">https://496c-222-152-99-121.ngrok-free.app/api/ciamhelper</Item>
						<Item Key="AuthenticationType">None</Item>
						<Item Key="SendClaimsIn">Body</Item>
						<Item Key="AllowInsecureAuthInProduction">true</Item>
					</Metadata>
					<InputClaims>
						<InputClaim ClaimTypeReferenceId="signInName" PartnerClaimType="email" />
						<InputClaim ClaimTypeReferenceId="password" />
						<InputClaim ClaimTypeReferenceId="method" DefaultValue="auth"
							AlwaysUseDefaultValue="true" />
					</InputClaims>
					<OutputClaims>
						<OutputClaim ClaimTypeReferenceId="graph_bearerToken"
							PartnerClaimType="access_token" />
					</OutputClaims>
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
				</TechnicalProfile>

				<TechnicalProfile Id="REST-fetchUserProfile-CIAM">
					<DisplayName>fetch user profile cross tenant</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<Item Key="ServiceUrl">https://graph.microsoft.com/beta/me</Item>
						<Item Key="AuthenticationType">Bearer</Item>
						<Item Key="UseClaimAsBearerToken">graph_bearerToken</Item>
						<Item Key="SendClaimsIn">Url</Item>
					</Metadata>
					<InputClaims>
						<InputClaim ClaimTypeReferenceId="graph_bearerToken" />
					</InputClaims>
					<OutputClaims>
						<OutputClaim ClaimTypeReferenceId="objectId" PartnerClaimType="id" />
						<OutputClaim ClaimTypeReferenceId="givenName" />
						<OutputClaim ClaimTypeReferenceId="surName" />
						<OutputClaim ClaimTypeReferenceId="displayName" />
						<OutputClaim ClaimTypeReferenceId="email" />
						<OutputClaim ClaimTypeReferenceId="userPrincipalName" PartnerClaimType="upn" />
						<OutputClaim ClaimTypeReferenceId="authenticationSource"
							DefaultValue="localAccountAuthentication" />
					</OutputClaims>
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
				</TechnicalProfile>

				<TechnicalProfile Id="REST-CIAM-UserUpdateUsingLogonEmail">
					<DisplayName>Update user in CIAM tenant</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<!-- Set the ServiceUrl with your own REST API endpoint -->
						<Item Key="ServiceUrl">https://496c-222-152-99-121.ngrok-free.app/api/ciamhelper</Item>
						<Item Key="SendClaimsIn">Body</Item>
						<!-- Set AuthenticationType to Basic or ClientCertificate in production
						environments -->
						<Item Key="AuthenticationType">None</Item>
						<!-- REMOVE the following line in production environments -->
						<Item Key="AllowInsecureAuthInProduction">true</Item>
						<!-- <Item Key="DefaultUserMessageIfRequestFailed">REST error</Item> -->
					</Metadata>
					<InputClaims>
						<!-- Claims sent to your REST API -->
						<InputClaim ClaimTypeReferenceId="signInName" PartnerClaimType="email"/>						
						<InputClaim ClaimTypeReferenceId="objectId" />
						<InputClaim ClaimTypeReferenceId="displayName" />
						<InputClaim ClaimTypeReferenceId="givenName" />
						<InputClaim ClaimTypeReferenceId="surName" />
						<InputClaim ClaimTypeReferenceId="userPrincipalName" />
						<InputClaim ClaimTypeReferenceId="method" AlwaysUseDefaultValue="true"
							DefaultValue="update" />
					</InputClaims>
					<OutputClaims>
						<!-- Claims parsed from your REST API -->
						<OutputClaim ClaimTypeReferenceId="objectId" PartnerClaimType="id" />
						<OutputClaim ClaimTypeReferenceId="displayName" />
						<OutputClaim ClaimTypeReferenceId="givenName" />
						<OutputClaim ClaimTypeReferenceId="surName" />
					</OutputClaims>
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
				</TechnicalProfile>

			</TechnicalProfiles>
		</ClaimsProvider>

		<ClaimsProvider>
			<DisplayName>Local Account MFA APIs</DisplayName>
			<TechnicalProfiles>
				<TechnicalProfile Id="REST-CIAM-UserUpdatePhoneNumberUsingObjectId">
					<DisplayName>Write user phoneMethod</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<!-- Set the ServiceUrl with your own REST API endpoint -->
						<Item Key="ServiceUrl">https://496c-222-152-99-121.ngrok-free.app/api/ciamhelper</Item>
						<Item Key="SendClaimsIn">Body</Item>
						<!-- Set AuthenticationType to Basic or ClientCertificate in production
						environments -->
						<Item Key="AuthenticationType">None</Item>
						<!-- REMOVE the following line in production environments -->
						<Item Key="AllowInsecureAuthInProduction">true</Item>
					</Metadata>
					<InputClaimsTransformations>
						<InputClaimsTransformation ReferenceId="PhoneNumberToString" />
					</InputClaimsTransformations>
					<InputClaims>
						<!-- Claims sent to your REST API -->
						<InputClaim ClaimTypeReferenceId="objectId" />
						<InputClaim ClaimTypeReferenceId="method" AlwaysUseDefaultValue="true"
							DefaultValue="setPhone" />
						<InputClaim ClaimTypeReferenceId="phoneNumberString"
							PartnerClaimType="phoneNumber" />
					</InputClaims>
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
				</TechnicalProfile>

				<TechnicalProfile Id="REST-CIAM-UserGetPhoneNumberUsingObjectId">
					<DisplayName>Write user phoneMethod</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<!-- Set the ServiceUrl with your own REST API endpoint -->
						<Item Key="ServiceUrl">https://496c-222-152-99-121.ngrok-free.app/api/ciamhelper</Item>
						<Item Key="SendClaimsIn">Body</Item>
						<!-- Set AuthenticationType to Basic or ClientCertificate in production
						environments -->
						<Item Key="AuthenticationType">None</Item>
						<!-- REMOVE the following line in production environments -->
						<Item Key="AllowInsecureAuthInProduction">true</Item>
					</Metadata>
					<InputClaims>
						<!-- Claims sent to your REST API -->
						<InputClaim ClaimTypeReferenceId="objectId" />
						<InputClaim ClaimTypeReferenceId="method" AlwaysUseDefaultValue="true"
							DefaultValue="getPhone" />
					</InputClaims>
					<OutputClaims>
						<!-- Claims parsed from your REST API -->
						<OutputClaim ClaimTypeReferenceId="phoneNumberString"
							PartnerClaimType="phoneNumber" DefaultValue="null" />
					</OutputClaims>
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
				</TechnicalProfile>

				<TechnicalProfile Id="REST-CIAM-UserWritePasswordUsingObjectId">
					<DisplayName>Write user phoneMethod</DisplayName>
					<Protocol Name="Proprietary"
						Handler="Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
					<Metadata>
						<!-- Set the ServiceUrl with your own REST API endpoint -->
						<Item Key="ServiceUrl">https://496c-222-152-99-121.ngrok-free.app/api/ciamhelper</Item>
						<Item Key="SendClaimsIn">Body</Item>
						<!-- Set AuthenticationType to Basic or ClientCertificate in production
						environments -->
						<Item Key="AuthenticationType">None</Item>
						<!-- REMOVE the following line in production environments -->
						<Item Key="AllowInsecureAuthInProduction">true</Item>
					</Metadata>
					<InputClaims>
						<!-- Claims sent to your REST API -->
						<InputClaim ClaimTypeReferenceId="objectId" />
						<InputClaim ClaimTypeReferenceId="newPassword" PartnerClaimType="password"/>
						<InputClaim ClaimTypeReferenceId="method" AlwaysUseDefaultValue="true"
							DefaultValue="resetPassword" />
					</InputClaims>					
					<UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
				</TechnicalProfile>
			</TechnicalProfiles>
		</ClaimsProvider>
	</ClaimsProviders>

	<UserJourneys>

		<UserJourney Id="CIAM-SignUpOrSignIn" DefaultCpimIssuerTechnicalProfileReferenceId="JwtIssuer">
			<OrchestrationSteps>

				<OrchestrationStep Order="1" Type="CombinedSignInAndSignUp"
					ContentDefinitionReferenceId="api.signuporsignin">
					<ClaimsProviderSelections>
						<ClaimsProviderSelection TargetClaimsExchangeId="GoogleExchange" />
						<ClaimsProviderSelection
							ValidationClaimsExchangeId="LocalAccountSigninEmailExchange" />
						<ClaimsProviderSelection TargetClaimsExchangeId="ForgotPasswordExchange" />
					</ClaimsProviderSelections>
					<ClaimsExchanges>
						<ClaimsExchange Id="LocalAccountSigninEmailExchange"
							TechnicalProfileReferenceId="CIAM-SelfAsserted-LocalAccountSignin-Email" />
					</ClaimsExchanges>
				</OrchestrationStep>

				<!-- Check if the user has selected to sign in using one of the social providers -->
				<OrchestrationStep Order="2" Type="ClaimsExchange">
					<Preconditions>
						<Precondition Type="ClaimsExist" ExecuteActionsIf="true">
							<Value>objectId</Value>
							<Action>SkipThisOrchestrationStep</Action>
						</Precondition>
					</Preconditions>
					<ClaimsExchanges>
						<ClaimsExchange Id="GoogleExchange"
							TechnicalProfileReferenceId="Google-OAuth2" />
						<ClaimsExchange Id="SignUpWithLogonEmailExchange"
							TechnicalProfileReferenceId="CIAM-SignUpWithLogonEmail" />
						<ClaimsExchange Id="ForgotPasswordExchange" TechnicalProfileReferenceId="ForgotPassword" />
					</ClaimsExchanges>
				</OrchestrationStep>

				<OrchestrationStep Order="3" Type="InvokeSubJourney">
					<Preconditions>
					  <Precondition Type="ClaimsExist" ExecuteActionsIf="false">
						<Value>isForgotPassword</Value>
						<Action>SkipThisOrchestrationStep</Action>
					  </Precondition>
					</Preconditions>
					<JourneyList>
					  <Candidate SubJourneyReferenceId="PasswordReset" />
					</JourneyList>
				  </OrchestrationStep>

				<!-- For social IDP authentication, attempt to find the user account in the
				directory. -->
				<OrchestrationStep Order="4" Type="ClaimsExchange">
					<Preconditions>
						<Precondition Type="ClaimEquals" ExecuteActionsIf="true">
							<Value>authenticationSource</Value>
							<Value>localAccountAuthentication</Value>
							<Action>SkipThisOrchestrationStep</Action>
						</Precondition>
					</Preconditions>
					<ClaimsExchanges>
						<!-- AAD-UserReadUsingAlternativeSecurityId-NoError -->
						<ClaimsExchange Id="CIAMUserReadUsingAlternativeSecurityId"
							TechnicalProfileReferenceId="REST-CIAM-UserReadUsingAlternativeSecurityId" />
					</ClaimsExchanges>
				</OrchestrationStep>

				<!-- Show self-asserted page only if the directory does not have the user account
				already (i.e. we do not have an objectId). 
			This can only happen when authentication happened using a social IDP. If local account was created
				or authentication done
			using ESTS in step 2, then an user account must exist in the directory by this time. -->
				<OrchestrationStep Order="5" Type="ClaimsExchange">
					<Preconditions>
						<Precondition Type="ClaimsExist" ExecuteActionsIf="true">
							<Value>objectId</Value>
							<Action>SkipThisOrchestrationStep</Action>
						</Precondition>
					</Preconditions>
					<ClaimsExchanges>
						<ClaimsExchange Id="CIAM-SelfAsserted-Social"
				TechnicalProfileReferenceId="CIAM-SelfAsserted-Social" />
					</ClaimsExchanges>
				</OrchestrationStep>

				<!-- This step reads any user attributes that we may not have received when
				authenticating using ESTS so they can be sent 
			in the token. -->
			<OrchestrationStep Order="6" Type="ClaimsExchange">
				<Preconditions>
					<Precondition Type="ClaimEquals" ExecuteActionsIf="true">
						<Value>authenticationSource</Value>
						<Value>socialIdpAuthentication</Value>
						<Action>SkipThisOrchestrationStep</Action>
					</Precondition>
				</Preconditions>
				<ClaimsExchanges>
					<ClaimsExchange Id="CIAMUserReadWithObjectId"
						TechnicalProfileReferenceId="REST-CIAM-UserReadUsingObjectIdOrEmail" />
				</ClaimsExchanges>
			</OrchestrationStep>

				<!-- The previous step (SelfAsserted-Social) could have been skipped if there were
				no attributes to collect 
			   from the user. So, in that case, create the user in the directory if one does not already exist 
			   (verified using objectId which would be set from the last step if account was created in the
				directory. -->
				<OrchestrationStep Order="7" Type="ClaimsExchange">
					<Preconditions>
						<Precondition Type="ClaimsExist" ExecuteActionsIf="true">
							<Value>objectId</Value>
							<Action>SkipThisOrchestrationStep</Action>
						</Precondition>
					</Preconditions>
					<ClaimsExchanges>
						<ClaimsExchange Id="CIAMUserWrite"
							TechnicalProfileReferenceId="REST-CIAM-UserWriteUsingAlternativeSecurityId" />
					</ClaimsExchanges>
				</OrchestrationStep>				

				<!-- Read the users phoneMethods from CIAM using objectid -->
				<OrchestrationStep Order="8" Type="ClaimsExchange">
					<ClaimsExchanges>
						<ClaimsExchange Id="Read-PhoneMethods-From-CIAM"
							TechnicalProfileReferenceId="REST-CIAM-UserGetPhoneNumberUsingObjectId" />
					</ClaimsExchanges>
				</OrchestrationStep>

				<!-- Show MFA enrolment screen if user doesnt have a phone number registered -->
				<OrchestrationStep Order="9" Type="ClaimsExchange">
					<Preconditions>
						<Precondition Type="ClaimEquals" ExecuteActionsIf="false">
							<Value>phoneNumberString</Value>
							<Value>null</Value>
							<Action>SkipThisOrchestrationStep</Action>
						</Precondition>
					</Preconditions>
					<ClaimsExchanges>
						<ClaimsExchange Id="Enrol-MFA-Step"
							TechnicalProfileReferenceId="SelfAsserted-Enrol-MFA" />
					</ClaimsExchanges>
				</OrchestrationStep>

				<!-- Show MFA challenge screen if user does have a phone number registered, and is
				not a sign up -->
				<OrchestrationStep Order="10" Type="ClaimsExchange">
					<Preconditions>
						<Precondition Type="ClaimsExist" ExecuteActionsIf="true">
							<Value>newUser</Value>
							<Action>SkipThisOrchestrationStep</Action>
						</Precondition>
						<Precondition Type="ClaimsExist" ExecuteActionsIf="true">
							<Value>newlyEnrolled</Value>
							<Action>SkipThisOrchestrationStep</Action>
						</Precondition>
					</Preconditions>
					<ClaimsExchanges>
						<ClaimsExchange Id="Perform-MFA-Step"
							TechnicalProfileReferenceId="SelfAsserted-MFA-Challenge" />
					</ClaimsExchanges>
				</OrchestrationStep>

				<OrchestrationStep Order="11" Type="SendClaims"
					CpimIssuerTechnicalProfileReferenceId="JwtIssuer" />

			</OrchestrationSteps>
			<ClientDefinition ReferenceId="DefaultWeb" />
		</UserJourney>

		<UserJourney Id="CIAM-PasswordReset">
			<OrchestrationSteps>
				<OrchestrationStep Order="1" Type="ClaimsExchange">
					<ClaimsExchanges>
						<ClaimsExchange Id="PasswordResetUsingEmailAddressExchange"
							TechnicalProfileReferenceId="CIAM-LocalAccountDiscoveryUsingEmailAddress" />
					</ClaimsExchanges>
				</OrchestrationStep>

				<!-- Read the users phoneMethods from CIAM using objectid -->
				<OrchestrationStep Order="2" Type="ClaimsExchange">
					<ClaimsExchanges>
						<ClaimsExchange Id="Read-PhoneMethods-From-CIAM"
							TechnicalProfileReferenceId="REST-CIAM-UserGetPhoneNumberUsingObjectId" />
					</ClaimsExchanges>
				</OrchestrationStep>	
				
				<!-- Show error screen if user does not have a phone number registered -->
				<OrchestrationStep Order="3" Type="ClaimsExchange">
					<Preconditions>						
						<Precondition Type="ClaimEquals" ExecuteActionsIf="false">
							<Value>phoneNumberString</Value>
							<Value>null</Value>
							<Action>SkipThisOrchestrationStep</Action>
						</Precondition>
					</Preconditions>
					<ClaimsExchanges>
						<ClaimsExchange Id="Error-MFA-Step"
							TechnicalProfileReferenceId="SelfAsserted-Error-MFA" />
					</ClaimsExchanges>
				</OrchestrationStep>

				<!-- Show MFA challenge screen via SMS if user does have a phone number registered, and is
				not a sign up -->
				<OrchestrationStep Order="4" Type="ClaimsExchange">
					<Preconditions>						
						<Precondition Type="ClaimEquals" ExecuteActionsIf="true">
							<Value>phoneNumberString</Value>
							<Value>null</Value>
							<Action>SkipThisOrchestrationStep</Action>
						</Precondition>
					</Preconditions>
					<ClaimsExchanges>
						<ClaimsExchange Id="Perform-MFA-Step"
							TechnicalProfileReferenceId="SelfAsserted-MFA-Challenge" />
					</ClaimsExchanges>
				</OrchestrationStep>				

				<OrchestrationStep Order="5" Type="ClaimsExchange">
					<ClaimsExchanges>
						<ClaimsExchange Id="NewCredentials"
							TechnicalProfileReferenceId="CIAM-LocalAccountWritePasswordUsingObjectId" />
					</ClaimsExchanges>
				</OrchestrationStep>

				<OrchestrationStep Order="6" Type="SendClaims"
					CpimIssuerTechnicalProfileReferenceId="JwtIssuer" />
			</OrchestrationSteps>
			<ClientDefinition ReferenceId="DefaultWeb" />
		</UserJourney>

		<UserJourney Id="CIAM-ProfileEdit">
			<OrchestrationSteps>

				<OrchestrationStep Order="1" Type="ClaimsExchange">
					<ClaimsExchanges>
						<ClaimsExchange Id="LocalAccountSigninEmailExchange"
							TechnicalProfileReferenceId="CIAM-SelfAsserted-LocalAccountSignin-Email" />
					</ClaimsExchanges>
				</OrchestrationStep>

				<OrchestrationStep Order="2" Type="ClaimsExchange">
					<ClaimsExchanges>
						<ClaimsExchange Id="CIAMUserReadWithObjectIdOrEmail"
							TechnicalProfileReferenceId="REST-CIAM-UserReadUsingObjectIdOrEmail" />
					</ClaimsExchanges>
				</OrchestrationStep>

				<!-- Read the users phoneMethods from CIAM using objectid -->
				<OrchestrationStep Order="3" Type="ClaimsExchange">
					<ClaimsExchanges>
						<ClaimsExchange Id="Read-PhoneMethods-From-CIAM"
							TechnicalProfileReferenceId="REST-CIAM-UserGetPhoneNumberUsingObjectId" />
					</ClaimsExchanges>
				</OrchestrationStep>	
				
				<!-- Show error screen if user does not have a phone number registered -->
				<OrchestrationStep Order="4" Type="ClaimsExchange">
					<Preconditions>						
						<Precondition Type="ClaimEquals" ExecuteActionsIf="false">
							<Value>phoneNumberString</Value>
							<Value>null</Value>
							<Action>SkipThisOrchestrationStep</Action>
						</Precondition>
					</Preconditions>
					<ClaimsExchanges>
						<ClaimsExchange Id="Error-MFA-Step"
							TechnicalProfileReferenceId="SelfAsserted-Error-MFA" />
					</ClaimsExchanges>
				</OrchestrationStep>

				<!-- Show MFA challenge screen via SMS if user does have a phone number registered, and is
				not a sign up -->
				<OrchestrationStep Order="5" Type="ClaimsExchange">
					<Preconditions>						
						<Precondition Type="ClaimEquals" ExecuteActionsIf="true">
							<Value>phoneNumberString</Value>
							<Value>null</Value>
							<Action>SkipThisOrchestrationStep</Action>
						</Precondition>
					</Preconditions>
					<ClaimsExchanges>
						<ClaimsExchange Id="Perform-MFA-Step"
							TechnicalProfileReferenceId="SelfAsserted-MFA-Challenge" />
					</ClaimsExchanges>
				</OrchestrationStep>			

				<OrchestrationStep Order="6" Type="ClaimsExchange">
					<ClaimsExchanges>
						<ClaimsExchange Id="CAIMUserProfileUpdateExchange"
							TechnicalProfileReferenceId="CIAM_SelfAsserted-ProfileUpdate" />
					</ClaimsExchanges>
				</OrchestrationStep>

				<OrchestrationStep Order="7" Type="ClaimsExchange">
					<ClaimsExchanges>
						<ClaimsExchange Id="CIAMUserProfileRESTUpdateExchange"
							TechnicalProfileReferenceId="REST-CIAM-UserUpdateUsingLogonEmail" />
					</ClaimsExchanges>
				</OrchestrationStep>				

				<OrchestrationStep Order="8" Type="SendClaims"
					CpimIssuerTechnicalProfileReferenceId="JwtIssuer" />
			</OrchestrationSteps>
			<ClientDefinition ReferenceId="DefaultWeb" />
		</UserJourney>
	</UserJourneys>

	<SubJourneys>
		<SubJourney Id="PasswordReset" Type="Transfer">
		  <OrchestrationSteps>
			<OrchestrationStep Order="1" Type="ClaimsExchange">
				<ClaimsExchanges>
					<ClaimsExchange Id="PasswordResetUsingEmailAddressExchange"
						TechnicalProfileReferenceId="CIAM-LocalAccountDiscoveryUsingEmailAddress" />
				</ClaimsExchanges>
			</OrchestrationStep>

			<!-- Read the users phoneMethods from CIAM using objectid -->
			<OrchestrationStep Order="2" Type="ClaimsExchange">
				<ClaimsExchanges>
					<ClaimsExchange Id="Read-PhoneMethods-From-CIAM"
						TechnicalProfileReferenceId="REST-CIAM-UserGetPhoneNumberUsingObjectId" />
				</ClaimsExchanges>
			</OrchestrationStep>	
			
			<!-- Show error screen if user does not have a phone number registered -->
			<OrchestrationStep Order="3" Type="ClaimsExchange">
				<Preconditions>						
					<Precondition Type="ClaimEquals" ExecuteActionsIf="false">
						<Value>phoneNumberString</Value>
						<Value>null</Value>
						<Action>SkipThisOrchestrationStep</Action>
					</Precondition>
				</Preconditions>
				<ClaimsExchanges>
					<ClaimsExchange Id="Error-MFA-Step"
						TechnicalProfileReferenceId="SelfAsserted-Error-MFA" />
				</ClaimsExchanges>
			</OrchestrationStep>

			<!-- Show MFA challenge screen via SMS if user does have a phone number registered, and is
			not a sign up -->
			<OrchestrationStep Order="4" Type="ClaimsExchange">
				<Preconditions>						
					<Precondition Type="ClaimEquals" ExecuteActionsIf="true">
						<Value>phoneNumberString</Value>
						<Value>null</Value>
						<Action>SkipThisOrchestrationStep</Action>
					</Precondition>
				</Preconditions>
				<ClaimsExchanges>
					<ClaimsExchange Id="Perform-MFA-Step"
						TechnicalProfileReferenceId="SelfAsserted-MFA-Challenge" />
				</ClaimsExchanges>
			</OrchestrationStep>				

			<OrchestrationStep Order="5" Type="ClaimsExchange">
				<ClaimsExchanges>
					<ClaimsExchange Id="NewCredentials"
						TechnicalProfileReferenceId="CIAM-LocalAccountWritePasswordUsingObjectId" />
				</ClaimsExchanges>
			</OrchestrationStep>

			<OrchestrationStep Order="6" Type="SendClaims"
					CpimIssuerTechnicalProfileReferenceId="JwtIssuer" />
		  </OrchestrationSteps>
		</SubJourney>
	  </SubJourneys>	

</TrustFrameworkPolicy>   